{% extends "base.html" %}

{% block title %}Checkout - E-Commerce Platform{% endblock %}

{% block content %}
<h2>Checkout</h2>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5>Shipping Information</h5>
            </div>
            <div class="card-body">
                <form id="checkout-form">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="first_name" class="form-label">First Name</label>
                            <input type="text" class="form-control" id="first_name" name="first_name" 
                                   value="{{ current_user.first_name }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="last_name" class="form-label">Last Name</label>
                            <input type="text" class="form-control" id="last_name" name="last_name" 
                                   value="{{ current_user.last_name }}" required>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="address" class="form-label">Address</label>
                        <textarea class="form-control" id="address" name="address" rows="3" 
                                  placeholder="Street address, city, state, zip code" required>{{ current_user.address or '' }}</textarea>
                    </div>
                    <div class="mb-3">
                        <label for="phone" class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" id="phone" name="phone" 
                               value="{{ current_user.phone or '' }}" required>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5>Payment Information</h5>
            </div>
            <div class="card-body">
                <div id="payment-element">
                    <!-- Stripe Elements will create form elements here -->
                </div>
                <div id="payment-errors" class="alert alert-danger d-none" role="alert"></div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>Order Summary</h5>
            </div>
            <div class="card-body">
                {% for item in cart_items %}
                <div class="d-flex justify-content-between mb-2">
                    <span>{{ item.product.name }} x{{ item.quantity }}</span>
                    <span>${{ "%.2f"|format(item.product.price * item.quantity) }}</span>
                </div>
                {% endfor %}
                <hr>
                <div class="d-flex justify-content-between">
                    <span>Subtotal:</span>
                    <span>${{ "%.2f"|format(total) }}</span>
                </div>
                <div class="d-flex justify-content-between">
                    <span>Shipping:</span>
                    <span>Free</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between fw-bold">
                    <span>Total:</span>
                    <span>${{ "%.2f"|format(total) }}</span>
                </div>
                
                <button id="submit-payment" class="btn btn-primary w-100 mt-3">
                    <span id="button-text">Place Order</span>
                    <div id="spinner" class="spinner-border spinner-border-sm d-none" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://js.stripe.com/v3/"></script>
<script>
const stripe = Stripe('{{ stripe_publishable_key }}');
let elements;
let paymentIntent;

initialize();

async function initialize() {
    // Create payment intent
    const response = await fetch('/create_payment_intent', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    });
    
    const { client_secret } = await response.json();
    
    elements = stripe.elements({ clientSecret: client_secret });
    
    const paymentElement = elements.create('payment');
    paymentElement.mount('#payment-element');
}

document.getElementById('submit-payment').addEventListener('click', handleSubmit);

async function handleSubmit(e) {
    e.preventDefault();
    
    const submitButton = document.getElementById('submit-payment');
    const buttonText = document.getElementById('button-text');
    const spinner = document.getElementById('spinner');
    
    // Disable button and show spinner
    submitButton.disabled = true;
    buttonText.classList.add('d-none');
    spinner.classList.remove('d-none');
    
    // Get shipping information
    const form = document.getElementById('checkout-form');
    const formData = new FormData(form);
    const shippingAddress = `${formData.get('first_name')} ${formData.get('last_name')}\n${formData.get('address')}\nPhone: ${formData.get('phone')}`;
    
    const { error, paymentIntent } = await stripe.confirmPayment({
        elements,
        redirect: 'if_required'
    });
    
    if (error) {
        // Show error to customer
        showError(error.message);
        
        // Re-enable button
        submitButton.disabled = false;
        buttonText.classList.remove('d-none');
        spinner.classList.add('d-none');
    } else if (paymentIntent.status === 'succeeded') {
        // Payment succeeded, confirm with server
        const confirmResponse = await fetch('/confirm_payment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                payment_intent_id: paymentIntent.id,
                shipping_address: shippingAddress
            })
        });
        
        const result = await confirmResponse.json();
        
        if (result.success) {
            // Redirect to order confirmation
            window.location.href = `/order/${result.order_id}`;
        } else {
            showError(result.error);
            submitButton.disabled = false;
            buttonText.classList.remove('d-none');
            spinner.classList.add('d-none');
        }
    }
}

function showError(message) {
    const errorDiv = document.getElementById('payment-errors');
    errorDiv.textContent = message;
    errorDiv.classList.remove('d-none');
    
    // Hide error after 5 seconds
    setTimeout(() => {
        errorDiv.classList.add('d-none');
    }, 5000);
}
</script>
{% endblock %}
